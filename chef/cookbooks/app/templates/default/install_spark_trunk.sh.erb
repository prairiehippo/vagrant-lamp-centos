#!/bin/sh

if [ ! -f /etc/redhat-release ];
then
  echo "This script must be run from within your VM."
  echo "To login to your vm, type: vagrant ssh"
  echo "Then: /www/install_spark_trunk.sh"
  exit 1;
fi

if [ -d /www/wpg.trunk/sites/wpg.trunk ];
then
  echo ""
  echo "/www/wpg.trunk/sites/wpg.trunk already exists. "
  read -p "Press enter to destroy your existing install. (cntl-c cancels)> " dummy
  echo ""
  echo "Granting user write permissions to /www/wpg.trunk/sites/wpg.trunk"
  chmod 777 -R /www/wpg.trunk/sites/wpg.trunk
  rm -rf /www/wpg.trunk/sites/wpg.trunk
fi

if [ ! -f /www/wpg_trunk_pb.txt ];
then
  echo ""
  echo "#####################################################################################"
  echo "You do not appear to have a backend PB for Spark."
  echo "I'll create one for you. You'll be prompted for the root password of the trunk-sandbox."
  echo "In the future, if you'd like to create a brand new PB, just run (from drupal root):"
  echo "profiles/create_spark_pb.sh --config=/www/wpg_trunk_pb.txt"
  echo "#####################################################################################"
  echo ""
  cd /www/wpg.trunk
  profiles/create_spark_pb.sh --config=/etc/wpg-trunk.config
fi

cd /www/wpg.trunk
profiles/spark-install.sh --config=/etc/wpg-trunk.config -y -d
echo "Finished installed Spark"

# echo ""
# echo "Symlinking sites/<%= @my_static_ip %> to sites/wpg.trunk"
# if [ -h /www/wpg.trunk/sites/<%= @my_static_ip %> ];
# then
#   unlink /www/wpg.trunk/sites/<%= @my_static_ip %>
# fi
# ln -s /www/wpg.trunk/sites/wpg.trunk /www/wpg.trunk/sites/<%= @my_static_ip %>

echo ""
echo "Symlinking sites/default/[files, settings.php] to sites/wpg.trunk"

if [ -h /www/wpg.trunk/sites/default/settings.php ];
then
  unlink /www/wpg.trunk/sites/default/settings.php
fi

if [ -h /www/wpg.trunk/sites/default/files ];
then
  unlink /www/wpg.trunk/sites/default/files
fi

ln -s /www/wpg.trunk/sites/wpg.trunk/settings.php /www/wpg.trunk/sites/default/settings.php
ln -s /www/wpg.trunk/sites/wpg.trunk/files /www/wpg.trunk/sites/default

echo ""
echo "To load your spark with users and data, run:"
echo "drush -l wpg.trunk -u 1 -y bvauto"

