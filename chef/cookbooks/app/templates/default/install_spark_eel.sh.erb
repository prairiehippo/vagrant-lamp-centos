#!/bin/sh

if [ ! -f /etc/redhat-release ];
then
  echo "This script must be run from within your VM."
  echo "To login to your vm, type: vagrant ssh"
  echo "Then: /www/install_spark_eel.sh"
  exit 1;
fi

if [ -d /www/wpg.eel/sites/wpg.eel ];
then
  echo ""
  echo "/www/wpg.eel/sites/wpg.eel already exists. "
  read -p "Press enter to destroy your existing install. (cntl-c cancels)> " dummy
  echo ""
  echo "Granting user write permissions to /www/wpg.eel/sites/wpg.eel"
  chmod 777 -R /www/wpg.eel/sites/wpg.eel
  rm -rf /www/wpg.eel/sites/wpg.eel
fi

if [ ! -f /www/wpg_eel_pb.txt ];
then
  echo ""
  echo "#####################################################################################"
  echo "You do not appear to have a backend PB for Spark."
  echo "I'll create one for you. You'll be prompted for the root password of the eel-sandbox."
  echo "In the future, if you'd like to create a brand new PB, just run (from drupal root):"
  echo "profiles/create_spark_pb.sh --config=/www/wpg_eel_pb.txt"
  echo "#####################################################################################"
  echo ""
  cd /www/wpg.eel
  profiles/create_spark_pb.sh --config=/etc/wpg-eel.config
fi

cd /www/wpg.eel
profiles/spark-install.sh --config=/etc/wpg-eel.config -y -d
echo "Finished installed Spark"

# echo ""
# echo "Symlinking sites/<%= @my_static_ip %> to sites/wpg.eel"
# if [ -h /www/wpg.eel/sites/<%= @my_static_ip %> ];
# then
#   unlink /www/wpg.eel/sites/<%= @my_static_ip %>
# fi
# ln -s /www/wpg.eel/sites/wpg.eel /www/wpg.eel/sites/<%= @my_static_ip %>

echo ""
echo "Symlinking sites/default/[files, settings.php] to sites/wpg.eel"

if [ -h /www/wpg.eel/sites/default/settings.php ];
then
  unlink /www/wpg.eel/sites/default/settings.php
fi

if [ -h /www/wpg.eel/sites/default/files ];
then
  unlink /www/wpg.eel/sites/default/files
fi

ln -s /www/wpg.eel/sites/wpg.eel/settings.php /www/wpg.eel/sites/default/settings.php
ln -s /www/wpg.eel/sites/wpg.eel/files /www/wpg.eel/sites/default

echo ""
echo "To load your spark with users and data, run:"
echo "drush -l wpg.eel -u 1 -y bvauto"

